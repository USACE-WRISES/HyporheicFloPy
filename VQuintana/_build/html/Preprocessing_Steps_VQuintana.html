
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Flopy Preprocessing Steps &#8212; Automating Groudwater Modelling with Python using FloPy</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Preprocessing_Steps_VQuintana';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="notebooks.html">
  
  
  
  
  
  
    <p class="title logo__title">Automating Groudwater Modelling with Python using FloPy</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="notebooks.html">
                    Content with notebooks
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="markdown.html">Markdown Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="markdown-notebooks.html">Notebooks with MyST Markdown</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/USACE-WRISES/HyporheicFloPy.git" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/USACE-WRISES/HyporheicFloPy.git/issues/new?title=Issue%20on%20page%20%2FPreprocessing_Steps_VQuintana.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Preprocessing_Steps_VQuintana.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Flopy Preprocessing Steps</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-files-to-personal-directory">Set Files to Personal Directory</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-terrain-elevation">Plot Terrain Elevation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-model-simulation">Set up Model Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-model-grid">Setting up Model Grid</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-terrain-elevation-and-model-grid">Plot Terrain Elevation and Model Grid</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stretch-model-grid-to-terrain-elevation">Stretch Model Grid to Terrain Elevation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-boundary-conditions">Define Boundary Conditions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-dis-package">Create DIS Package</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identify-boundary-cells">Identify Boundary Cells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find-ground-water-elevation">Find Ground Water Elevation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-constant-head-to-boundary-conditions">Assign Constant Head to Boundary Conditions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-constant-head-boundary-package">Create the Constant Head Boundary Package</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recharge-package">Recharge Package</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-wells">Add Wells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identify-river-cells">Identify River Cells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-nodes">Create Nodes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-model-simulation">Run Model Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-modpath">Set up MODPATH</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="flopy-preprocessing-steps">
<h1>Flopy Preprocessing Steps<a class="headerlink" href="#flopy-preprocessing-steps" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>import libraries</p></li>
<li><p>set file paths</p></li>
<li><p>load input files</p>
<ul>
<li><p>water surface elevation raster</p></li>
<li><p>ground water domain shapefile</p></li>
<li><p>left polyline boundary for floodplain</p></li>
<li><p>right polyline boundary for floodplain</p></li>
</ul>
</li>
<li><p>boundary conditions</p>
<ul>
<li><p>water surface elevation raster converted to shapefile</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make sure you&#39;re in virtual environment by running &quot;.\\.venv\Scripts\activate&quot; in terminal</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">flopy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rasterio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.crs</span><span class="w"> </span><span class="kn">import</span> <span class="n">CRS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.warp</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_default_transform</span><span class="p">,</span> <span class="n">reproject</span><span class="p">,</span> <span class="n">Resampling</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">from_bounds</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">rowcol</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.mask</span><span class="w"> </span><span class="kn">import</span> <span class="n">mask</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">box</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">LineString</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flopy.utils.binaryfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">HeadFile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">griddata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># Import libraries</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="kn">import</span><span class="w"> </span><span class="nn">flopy</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">File</span> <span class="n">c</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">u4eeevmq</span>\<span class="n">Documents</span>\<span class="n">Python</span>\<span class="n">HyporheicFloPy</span>\<span class="o">.</span><span class="n">venv</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">flopy</span>\<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">27</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> <span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;FloPy Team&quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="kn">from</span><span class="w"> </span><span class="nn">.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>  <span class="c1"># isort:skip</span>
<span class="ne">---&gt; </span><span class="mi">27</span> <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span>     <span class="n">discretization</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span>     <span class="n">export</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span>     <span class="n">mf6</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>     <span class="n">mfusg</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span>     <span class="n">modflow</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span>     <span class="n">modflowlgr</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span>     <span class="n">modpath</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span>     <span class="n">mt3d</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span>     <span class="n">pest</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span>     <span class="n">plot</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">38</span>     <span class="n">seawat</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">39</span>     <span class="n">utils</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">40</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">41</span> <span class="kn">from</span><span class="w"> </span><span class="nn">.mbase</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_model</span><span class="p">,</span> <span class="n">which</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span> <span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
<span class="g g-Whitespace">     </span><span class="mi">44</span>     <span class="s2">&quot;__author__&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">45</span>     <span class="s2">&quot;__version__&quot;</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span>     <span class="s2">&quot;which&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">60</span> <span class="p">]</span>

<span class="n">File</span> <span class="n">c</span><span class="p">:</span>\<span class="n">Users</span>\<span class="n">u4eeevmq</span>\<span class="n">Documents</span>\<span class="n">Python</span>\<span class="n">HyporheicFloPy</span>\<span class="o">.</span><span class="n">venv</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">flopy</span>\<span class="n">modflowlgr</span>\<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span><span class="w"> </span><span class="nn">.mflgr</span><span class="w"> </span><span class="kn">import</span> <span class="n">LgrChild</span><span class="p">,</span> <span class="n">ModflowLgr</span>

<span class="nn">File &lt;frozen importlib._bootstrap&gt;:1176,</span> in <span class="ni">_find_and_load</span><span class="nt">(name, import_)</span>

<span class="nn">File &lt;frozen importlib._bootstrap&gt;:1147,</span> in <span class="ni">_find_and_load_unlocked</span><span class="nt">(name, import_)</span>

<span class="nn">File &lt;frozen importlib._bootstrap&gt;:690,</span> in <span class="ni">_load_unlocked</span><span class="nt">(spec)</span>

<span class="nn">File &lt;frozen importlib._bootstrap_external&gt;:936,</span> in <span class="ni">exec_module</span><span class="nt">(self, module)</span>

<span class="nn">File &lt;frozen importlib._bootstrap_external&gt;:1032,</span> in <span class="ni">get_code</span><span class="nt">(self, fullname)</span>

<span class="nn">File &lt;frozen importlib._bootstrap_external&gt;:1130,</span> in <span class="ni">get_data</span><span class="nt">(self, path)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<section id="set-files-to-personal-directory">
<h2>Set Files to Personal Directory<a class="headerlink" href="#set-files-to-personal-directory" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Input Data</span>
<span class="c1">## Data Paths</span>
<span class="n">water_surface_elevation_raster</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\u4eeevmq\Documents\Python\test_12_18_2024\CH00365\GMS\WSE (Max).USGS_1m_FebApril2018_DEM.U_USGS-3DEP_dtm_hyrdo_flattened_20240412.2041_1.tif&quot;</span>
<span class="n">terrain_elevation_raster</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\u4eeevmq\Documents\Python\test_12_18_2024\CH00365\GMS\BlendedTerrain.LoweredTerrain.tif&quot;</span>
<span class="n">ground_water_domain_shapefile</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\u4eeevmq\Documents\Python\test_12_18_2024\InputShapefiles\GWDomain.shp&quot;</span>
<span class="n">left_boundary_floodplain</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\u4eeevmq\Documents\Python\test_12_18_2024\InputShapefiles\L_FPL.shp&quot;</span>
<span class="n">right_boundary_floodplain</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\u4eeevmq\Documents\Python\test_12_18_2024\InputShapefiles\R_FPL.shp&quot;</span>

<span class="c1">## Projection File Path</span>
<span class="n">projection_file</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\u4eeevmq\Documents\Python\test_12_18_2024\CH00365\RAS\GIS_Data\102739_TX_central.prj&quot;</span>

<span class="c1">## HEC-RAS CRS</span>
<span class="n">hec_ras_crs</span> <span class="o">=</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">projection_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

<span class="c1"># Load raster and shapefiles</span>
<span class="c1">#---------------------------------Terrain Elevation -----------------------------------------#</span>
<span class="c1"># Open the terrain raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">terrain_elevation_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">terrain_elevation</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">raster_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
    <span class="n">raster_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

    <span class="c1"># Calculate the new transform and dimensions</span>
    <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">calculate_default_transform</span><span class="p">(</span>
        <span class="n">raster_crs</span><span class="p">,</span> <span class="n">hec_ras_crs</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
    <span class="p">)</span>

    <span class="c1"># Define metadata for the new raster</span>
    <span class="n">new_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">hec_ras_crs</span><span class="p">,</span>
        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height</span>
    <span class="p">})</span>

    <span class="c1"># Define output file name</span>
    <span class="n">output_raster</span> <span class="o">=</span> <span class="s2">&quot;reprojected_terrain_raster.tif&quot;</span>

    <span class="c1"># Reproject and save</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_raster</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">new_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">reproject</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">src_transform</span><span class="o">=</span><span class="n">raster_transform</span><span class="p">,</span>
            <span class="n">src_crs</span><span class="o">=</span><span class="n">raster_crs</span><span class="p">,</span>
            <span class="n">dst_transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">dst_crs</span><span class="o">=</span><span class="n">hec_ras_crs</span><span class="p">,</span>
            <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span>
        <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojected raster saved as </span><span class="si">{</span><span class="n">output_raster</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1">#---------------------------------Water Surface Elevation -----------------------------------------#</span>
<span class="c1"># Open the input raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">water_surface_elevation_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">surface_elevation</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">raster_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
    <span class="n">raster_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>

    <span class="c1"># Calculate the new transform and dimensions</span>
    <span class="n">transform</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">calculate_default_transform</span><span class="p">(</span>
        <span class="n">raster_crs</span><span class="p">,</span> <span class="n">hec_ras_crs</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
    <span class="p">)</span>
    
    <span class="c1"># Define metadata for the new raster</span>
    <span class="n">new_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;crs&quot;</span><span class="p">:</span> <span class="n">hec_ras_crs</span><span class="p">,</span>
        <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height</span>
    <span class="p">})</span>

    <span class="c1"># Define output file name</span>
    <span class="n">output_raster</span> <span class="o">=</span> <span class="s2">&quot;reprojected_water_surface_elevation_raster.tif&quot;</span>

    <span class="c1"># Reproject and save</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_raster</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">new_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">reproject</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">destination</span><span class="o">=</span><span class="n">rasterio</span><span class="o">.</span><span class="n">band</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">src_transform</span><span class="o">=</span><span class="n">raster_transform</span><span class="p">,</span>
            <span class="n">src_crs</span><span class="o">=</span><span class="n">raster_crs</span><span class="p">,</span>
            <span class="n">dst_transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">dst_crs</span><span class="o">=</span><span class="n">hec_ras_crs</span><span class="p">,</span>
            <span class="n">resampling</span><span class="o">=</span><span class="n">Resampling</span><span class="o">.</span><span class="n">nearest</span>
        <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reprojected raster saved as </span><span class="si">{</span><span class="n">output_raster</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Crop the water surface elevation raster to the terrain extent</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">terrain_bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
    <span class="n">terrain_geom</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">terrain_bounds</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">water_surface_elevation_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">out_image</span><span class="p">,</span> <span class="n">out_transform</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="n">terrain_geom</span><span class="p">],</span> <span class="n">crop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">out_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">out_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">out_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">out_transform</span>
        <span class="p">})</span>

        <span class="n">cropped_output_raster</span> <span class="o">=</span> <span class="s2">&quot;cropped_water_surface_elevation_raster.tif&quot;</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cropped_output_raster</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_image</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cropped water surface elevation raster saved as </span><span class="si">{</span><span class="n">cropped_output_raster</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Read and plot the cropped water surface elevation raster</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cropped_output_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">cropped_surface_elevation</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cropped_surface_elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">cropped_surface_elevation</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>
    <span class="n">cropped_surface_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">show</span><span class="p">(</span><span class="n">cropped_surface_elevation</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">cropped_surface_transform</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>
    
<span class="c1">#---------------------------------Shapefiles -----------------------------------------#</span>
<span class="c1"># Load and reproject shapefiles to match the raster CRS</span>
<span class="n">ground_water_domain</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">ground_water_domain_shapefile</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">hec_ras_crs</span><span class="p">)</span>
<span class="n">left_boundary</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">left_boundary_floodplain</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">hec_ras_crs</span><span class="p">)</span>
<span class="n">right_boundary</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">right_boundary_floodplain</span><span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">hec_ras_crs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-terrain-elevation">
<h2>Plot Terrain Elevation<a class="headerlink" href="#plot-terrain-elevation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Plot Terrain Elevation</span>
<span class="n">reprojected_terrain_elevation_raster</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\u4eeevmq\Documents\Python\test_12_18_2024\reprojected_terrain_raster.tif&quot;</span>

<span class="c1"># Assuming `src.nodata` is the no-data value for the raster</span>
<span class="n">terrain_elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">terrain_elevation</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>

<span class="c1"># Now you can use .compressed()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">terrain_elevation</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of Elevation Values&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Elevation (m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Map</span>
<span class="c1"># Load the raster file</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reprojected_terrain_elevation_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">terrain_elevation</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Read the first band</span>
    <span class="n">surface_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">top</span><span class="p">]</span>

    <span class="c1"># Mask no-data values if present</span>
    <span class="n">terrain_elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">terrain_elevation</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>

<span class="c1"># Plot the surface elevation</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">terrain_elevation</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">surface_extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Terrain Elevation (m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Terrain Elevation Map&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-up-model-simulation">
<h2>Set up Model Simulation<a class="headerlink" href="#set-up-model-simulation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Initialize Model</span>
<span class="c1"># Define model name and executable path</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;gfw&quot;</span>
<span class="n">exe_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;C:\Users\u4eeevmq\Documents\Python\Flo_Py\flopy\modflowExe\mf6.exe&quot;</span>  <span class="c1"># Update to your MODFLOW-6 executable path</span>
<span class="n">sim_name</span> <span class="o">=</span> <span class="s2">&quot;gfw&quot;</span>
<span class="n">workspace</span> <span class="o">=</span> <span class="s2">&quot;./modflow6_workspace&quot;</span>

<span class="c1"># Model units</span>
<span class="n">length_units</span> <span class="o">=</span> <span class="s2">&quot;feet&quot;</span>
<span class="n">time_units</span> <span class="o">=</span> <span class="s2">&quot;days&quot;</span>

<span class="c1"># Clear the workspace directory if it exists</span>
<span class="c1">#if os.path.exists(workspace):</span>
<span class="c1">#    shutil.rmtree(workspace)</span>
<span class="c1">#os.makedirs(workspace)</span>

<span class="c1"># Create the MODFLOW 6 simulation</span>
<span class="n">sim</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">MFSimulation</span><span class="p">(</span><span class="n">sim_name</span><span class="o">=</span><span class="n">sim_name</span><span class="p">,</span> <span class="n">exe_name</span><span class="o">=</span><span class="n">exe_path</span><span class="p">,</span> <span class="n">sim_ws</span><span class="o">=</span><span class="n">workspace</span><span class="p">)</span>

<span class="c1"># Define temporal discretization (TDIS package)</span>
<span class="n">nper</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Number of stress periods</span>
<span class="n">tdis</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowTdis</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">nper</span><span class="o">=</span><span class="n">nper</span><span class="p">,</span> <span class="n">perioddata</span><span class="o">=</span><span class="p">[(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)])</span>  <span class="c1"># 1 stress period, 1 time step</span>

<span class="c1"># Add IMS package (solver settings)</span>
<span class="n">ims</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowIms</span><span class="p">(</span>
    <span class="n">sim</span><span class="p">,</span>
    <span class="n">print_option</span><span class="o">=</span><span class="s2">&quot;SUMMARY&quot;</span><span class="p">,</span>
    <span class="n">outer_dvclose</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>  <span class="c1"># Increase convergence criteria for outer iterations</span>
    <span class="n">outer_maximum</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>  <span class="c1"># Increase maximum number of outer iterations</span>
    <span class="n">under_relaxation</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
    <span class="n">inner_maximum</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>  <span class="c1"># Increase maximum number of inner iterations</span>
    <span class="n">inner_dvclose</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>  <span class="c1"># Increase convergence criteria for inner iterations</span>
    <span class="n">rcloserecord</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>  <span class="c1"># Increase residual convergence criteria</span>
    <span class="n">linear_acceleration</span><span class="o">=</span><span class="s2">&quot;BICGSTAB&quot;</span><span class="p">,</span>  <span class="c1"># Switch to Bi-Conjugate Gradient Stabilized method</span>
    <span class="n">scaling_method</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
    <span class="n">reordering_method</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
    <span class="n">relaxation_factor</span><span class="o">=</span><span class="mf">0.97</span><span class="p">,</span>  <span class="c1"># Adjust relaxation factor</span>
<span class="p">)</span>

<span class="c1"># Create the GWF model</span>
<span class="n">gwf</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowGwf</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">modelname</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">save_flows</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-up-model-grid">
<h2>Setting up Model Grid<a class="headerlink" href="#setting-up-model-grid" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Define Model Grid</span>
<span class="n">bed_elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">terrain_elevation</span><span class="p">)</span> <span class="c1"># Bed elevation is the minimum value of the cropped surface elevation</span>

<span class="c1"># Define cell size in feet</span>
<span class="n">cell_size_x</span> <span class="o">=</span> <span class="n">cell_size_y</span> <span class="o">=</span> <span class="mf">10.0</span>  <span class="c1"># Grid cell size (10x10 feet) calculated from raster resolution</span>

<span class="c1"># Calculate the extent of the raster</span>
<span class="n">raster_width</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Width in feet</span>
<span class="n">raster_height</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">transform</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>  <span class="c1"># Height in feet</span>

<span class="c1"># Determine the number of rows and columns based on the cell size</span>
<span class="n">ncol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raster_width</span> <span class="o">/</span> <span class="n">cell_size_x</span><span class="p">)</span>
<span class="n">nrow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">raster_height</span> <span class="o">/</span> <span class="n">cell_size_y</span><span class="p">)</span>

<span class="c1"># Print the calculated grid dimensions</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of columns: </span><span class="si">{</span><span class="n">ncol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of rows: </span><span class="si">{</span><span class="n">nrow</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">gw_mod_depth</span> <span class="o">=</span> <span class="mf">20.0</span>  <span class="c1"># Depth of the groundwater model (20 feet below the bed surface)</span>
<span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> <span class="n">gw_mod_depth</span><span class="p">)</span>  <span class="c1"># feet below bed surface (depth of groundwater model)</span>
<span class="n">z</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Default layer thickness </span>
<span class="n">nlay</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">z</span><span class="p">)</span>  <span class="c1"># Number of groundwater layers based on default depth)</span>

<span class="c1"># Calculate grid cell centers</span>
<span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_size_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">cell_size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_size_y</span> <span class="o">+</span> <span class="p">(</span><span class="n">cell_size_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Convert cell centers to Points for intersection checks</span>
<span class="n">grid_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grid_x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">ravel</span><span class="p">())]},</span>
    <span class="n">crs</span><span class="o">=</span> <span class="n">hec_ras_crs</span><span class="p">,</span>  <span class="c1"># Replace with the actual CRS of your grid</span>
<span class="p">)</span>

<span class="c1"># Read raster data and extract elevation values</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reprojected_terrain_elevation_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="n">raster_array</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Read the first band</span>
    <span class="n">raster_transform</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
    <span class="n">raster_crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">crs</span>
    <span class="n">raster_bounds_box</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>  <span class="c1"># Create a shapely box for raster bounds</span>
    <span class="n">terrain_elevation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">raster_array</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">nodata</span><span class="p">)</span>  <span class="c1"># Mask no-data values</span>

<span class="c1"># Create a GeoDataFrame for raster bounds</span>
<span class="n">raster_bounds_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">raster_bounds_box</span><span class="p">]},</span> <span class="n">crs</span><span class="o">=</span><span class="n">hec_ras_crs</span>
<span class="p">)</span>

<span class="c1"># Reproject grid points to match raster CRS</span>
<span class="c1"># Use the raster bounds to define the grid extent</span>
<span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">raster_bounds_box</span><span class="o">.</span><span class="n">bounds</span>
<span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">miny</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">nrow</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Recreate the grid points</span>
<span class="n">grid_points</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grid_x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">ravel</span><span class="p">())]},</span>
    <span class="n">crs</span><span class="o">=</span><span class="n">raster_crs</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Check intersection between grid points and raster bounds</span>
<span class="n">intersecting_points</span> <span class="o">=</span> <span class="n">grid_points</span><span class="p">[</span><span class="n">grid_points</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">raster_bounds_box</span><span class="p">)]</span>

<span class="c1"># Debugging: Print details about the GeoDataFrames</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raster CRS: </span><span class="si">{</span><span class="n">raster_bounds_gdf</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid CRS: </span><span class="si">{</span><span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of grid points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_points</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of intersecting points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">intersecting_points</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plotting the model grid and raster intersections</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the raster bounds</span>
<span class="n">raster_bounds_gdf</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Raster Bounds&quot;</span><span class="p">)</span>

<span class="c1"># Plot the model grid points</span>
<span class="n">grid_points</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Grid Points&quot;</span><span class="p">)</span>

<span class="c1"># Plot the intersecting points</span>
<span class="n">intersecting_points</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Intersecting Points&quot;</span><span class="p">)</span>

<span class="c1"># Customize the plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Model Grid and Raster Intersection&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-terrain-elevation-and-model-grid">
<h2>Plot Terrain Elevation and Model Grid<a class="headerlink" href="#plot-terrain-elevation-and-model-grid" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Visualize Data</span>
<span class="c1"># Plot the raster of surface elevation over the model domain</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the raster surface elevation</span>
<span class="n">plt_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">raster_bounds_box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">raster_bounds_box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
              <span class="n">raster_bounds_box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">raster_bounds_box</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
<span class="n">elevation_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">terrain_elevation</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="n">plt_extent</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
<span class="p">)</span>

<span class="c1"># Add the model grid points</span>
<span class="c1">#grid_points.plot(ax=ax, color=&quot;blue&quot;, markersize=1, label=&quot;Model Grid Points&quot;)</span>

<span class="c1"># Add the raster bounds for reference</span>
<span class="n">raster_bounds_gdf</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Raster Bounds&quot;</span><span class="p">)</span>

<span class="c1"># Add a colorbar for the raster</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">elevation_plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Terrain Elevation (ft)&quot;</span><span class="p">)</span>

<span class="c1"># Customize the plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Terrain Elevation Over Model Domain&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Set x and y origin</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">raster_bounds_box</span><span class="o">.</span><span class="n">bounds</span>  <span class="c1"># Extract bounding box extent</span>
<span class="n">xorigin</span> <span class="o">=</span> <span class="n">xmin</span>  <span class="c1"># Set xorigin to the left-most boundary</span>
<span class="n">yorigin</span> <span class="o">=</span> <span class="n">ymin</span>  <span class="c1"># Set yorigin to the bottom-most boundary</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="stretch-model-grid-to-terrain-elevation">
<h2>Stretch Model Grid to Terrain Elevation<a class="headerlink" href="#stretch-model-grid-to-terrain-elevation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Stretch Model Grid to Terrain Surface Elevation</span>
<span class="c1"># Extract raster extent before looping</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">raster_transform</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">c</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">f</span>
<span class="n">xmax</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">terrain_elevation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">transform</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="p">(</span><span class="n">terrain_elevation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">transform</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Raster Extent: X = (</span><span class="si">{</span><span class="n">xmin</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">xmax</span><span class="si">}</span><span class="s2">), Y = (</span><span class="si">{</span><span class="n">ymin</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ymax</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Function to interpolate NA values</span>
<span class="k">def</span><span class="w"> </span><span class="nf">interpolate_na</span><span class="p">(</span><span class="n">terrain</span><span class="p">):</span>
    <span class="c1"># Get the coordinates of the non-masked values</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">terrain</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">valid_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">valid_values</span> <span class="o">=</span> <span class="n">terrain</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

    <span class="c1"># Get the coordinates of the masked values</span>
    <span class="n">invalid_mask</span> <span class="o">=</span> <span class="n">terrain</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">invalid_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">invalid_mask</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Interpolate the values at the masked coordinates</span>
    <span class="n">interpolated_values</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">valid_coords</span><span class="p">,</span> <span class="n">valid_values</span><span class="p">,</span> <span class="n">invalid_coords</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

    <span class="c1"># Fill the masked values with the interpolated values</span>
    <span class="n">terrain</span><span class="p">[</span><span class="n">invalid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolated_values</span>

    <span class="k">return</span> <span class="n">terrain</span>

<span class="c1"># Interpolate missing values in the terrain elevation</span>
<span class="c1">#terrain_elevation = interpolate_na(terrain_elevation)</span>

<span class="c1"># Initialize the top array</span>
<span class="n">top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Update &quot;top&quot; values for each cell in the first layer based on surface elevation</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">grid_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
        <span class="c1"># Calculate the x, y coordinates of the cell center</span>
        <span class="n">point_x</span> <span class="o">=</span> <span class="n">grid_x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">grid_col</span><span class="p">]</span>
        <span class="n">point_y</span> <span class="o">=</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">grid_col</span><span class="p">]</span>

        <span class="c1"># Convert the grid cell center coordinates to raster indices</span>
        <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="o">~</span><span class="n">raster_transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">point_x</span><span class="p">,</span> <span class="n">point_y</span><span class="p">)</span>
        <span class="n">col</span><span class="p">,</span> <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># Check if the indices are within raster bounds</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">terrain_elevation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">terrain_elevation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">elevation_value</span> <span class="o">=</span> <span class="n">terrain_elevation</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>

            <span class="c1"># Update &quot;top&quot; based on the raster value</span>
            <span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">grid_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">elevation_value</span>

<span class="c1"># Interpolate any remaining NA values in the top array</span>
<span class="n">top</span> <span class="o">=</span> <span class="n">interpolate_na</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">top</span><span class="p">))</span>

<span class="c1">## Initialize `tops` and `botm` lists</span>
<span class="n">tops</span> <span class="o">=</span> <span class="p">[</span><span class="n">top</span><span class="p">]</span>  <span class="c1"># Add the top layer (surface elevation or default)</span>
<span class="n">botm</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># First layer bottom is calculated from the updated &quot;top&quot; values</span>
<span class="n">first_layer_botm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">bed_elevation</span><span class="p">)</span>  <span class="c1"># Subtract 0.5 ft for the first layer</span>
<span class="n">botm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_layer_botm</span><span class="p">)</span>

<span class="c1"># Create remaining layers with a constant thickness of 0.5 ft</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">):</span>  <span class="c1"># Layers 2 to 40</span>
    <span class="n">next_layer_top</span> <span class="o">=</span> <span class="n">botm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># The top of the current layer is the bottom of the previous layer</span>
    <span class="n">next_layer_botm</span> <span class="o">=</span> <span class="n">next_layer_top</span> <span class="o">-</span> <span class="n">z</span>  <span class="c1"># Subtract thickness from the top</span>
    <span class="n">tops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_layer_top</span><span class="p">)</span>  <span class="c1"># Add the top of the current layer</span>
    <span class="n">botm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_layer_botm</span><span class="p">)</span>  <span class="c1"># Add the bottom of the current layer</span>

<span class="c1"># Debugging: Check the top and bottom elevations for all layers</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top layer elevation (max, min):&quot;</span><span class="p">,</span> <span class="n">tops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">botm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="k">for</span> <span class="n">layer_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layer </span><span class="si">{</span><span class="n">layer_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> top (max, min):&quot;</span><span class="p">,</span> <span class="n">tops</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">tops</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layer </span><span class="si">{</span><span class="n">layer_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> botm (max, min):&quot;</span><span class="p">,</span> <span class="n">botm</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">botm</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

<span class="c1">## Visualization: Plot the top and last bottom layers</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the top layer elevation</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>  <span class="c1">#  Ensures (0,0) is bottom-left</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Top Layer Elevation&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Row&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Elevation (ft)&quot;</span><span class="p">)</span>

<span class="c1"># Plot the bottom layer elevation (Layer 40)</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">botm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>  <span class="c1">#  Ensures bottom-left</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Bottom Layer Elevation (Layer 40)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Column&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Row&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Elevation (ft)&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-boundary-conditions">
<h2>Define Boundary Conditions<a class="headerlink" href="#define-boundary-conditions" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Create Boundary Conditions </span>
<span class="c1"># Extract the first (start) and last (end) coordinates from each boundary geometry</span>
<span class="n">left_start</span> <span class="o">=</span> <span class="n">left_boundary</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># First point</span>
<span class="n">left_end</span> <span class="o">=</span> <span class="n">left_boundary</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Last point</span>

<span class="n">right_start</span> <span class="o">=</span> <span class="n">right_boundary</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># First point</span>
<span class="n">right_end</span> <span class="o">=</span> <span class="n">right_boundary</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Last point</span>

<span class="c1"># Print start and end coordinates</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Left Boundary Start: </span><span class="si">{</span><span class="n">left_start</span><span class="si">}</span><span class="s2">, Left Boundary End: </span><span class="si">{</span><span class="n">left_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Right Boundary Start: </span><span class="si">{</span><span class="n">right_start</span><span class="si">}</span><span class="s2">, Right Boundary End: </span><span class="si">{</span><span class="n">right_end</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Upstream boundary coordinates (use left and right start points)</span>
<span class="n">upstream_start_x</span><span class="p">,</span> <span class="n">upstream_start_y</span> <span class="o">=</span> <span class="n">left_start</span>  <span class="c1"># Start of upstream from left boundary</span>
<span class="n">upstream_end_x</span><span class="p">,</span> <span class="n">upstream_end_y</span> <span class="o">=</span> <span class="n">right_start</span>  <span class="c1"># End of upstream from right boundary</span>

<span class="c1"># Downstream boundary coordinates (use left and right end points)</span>
<span class="n">downstream_start_x</span><span class="p">,</span> <span class="n">downstream_start_y</span> <span class="o">=</span> <span class="n">left_end</span>  <span class="c1"># Start of downstream from left boundary</span>
<span class="n">downstream_end_x</span><span class="p">,</span> <span class="n">downstream_end_y</span> <span class="o">=</span> <span class="n">right_end</span>  <span class="c1"># End of downstream from right boundary</span>

<span class="c1"># Print extracted coordinates</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upstream Start: (</span><span class="si">{</span><span class="n">upstream_start_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">upstream_start_y</span><span class="si">}</span><span class="s2">), Upstream End: (</span><span class="si">{</span><span class="n">upstream_end_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">upstream_end_y</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downstream Start: (</span><span class="si">{</span><span class="n">downstream_start_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">downstream_start_y</span><span class="si">}</span><span class="s2">), Downstream End: (</span><span class="si">{</span><span class="n">downstream_end_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">downstream_end_y</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Use the extracted start and end points</span>
<span class="n">upstream_line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([(</span><span class="n">upstream_start_x</span><span class="p">,</span> <span class="n">upstream_start_y</span><span class="p">),</span> <span class="p">(</span><span class="n">upstream_end_x</span><span class="p">,</span> <span class="n">upstream_end_y</span><span class="p">)])</span>
<span class="n">downstream_line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([(</span><span class="n">downstream_start_x</span><span class="p">,</span> <span class="n">downstream_start_y</span><span class="p">),</span> <span class="p">(</span><span class="n">downstream_end_x</span><span class="p">,</span> <span class="n">downstream_end_y</span><span class="p">)])</span>

<span class="c1"># Convert to GeoDataFrame</span>
<span class="n">upstream_boundary</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">upstream_line</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">left_boundary</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">downstream_boundary</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">downstream_line</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">left_boundary</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="c1"># Print boundary lines</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upstream Line: </span><span class="si">{</span><span class="n">upstream_line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downstream Line: </span><span class="si">{</span><span class="n">downstream_line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Visualize Groundwater Data</span>
<span class="c1"># Create a figure and axis</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot groundwater domain</span>
<span class="k">if</span> <span class="s1">&#39;ground_water_domain&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ground_water_domain</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="n">ground_water_domain</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Groundwater Domain&quot;</span><span class="p">)</span>

<span class="c1"># Plot left and right floodplain boundaries</span>
<span class="k">if</span> <span class="s1">&#39;left_boundary&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">left_boundary</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="n">left_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left Floodplain Boundary&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="s1">&#39;right_boundary&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">right_boundary</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="n">right_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right Floodplain Boundary&quot;</span><span class="p">)</span>

<span class="c1"># Plot upstream and downstream boundary lines</span>
<span class="k">if</span> <span class="s1">&#39;upstream_boundary&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">upstream_boundary</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="n">upstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upstream Boundary&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="s1">&#39;downstream_boundary&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">downstream_boundary</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="n">downstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Downstream Boundary&quot;</span><span class="p">)</span>

<span class="c1"># Set plot labels and title</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Groundwater Domain and Boundary Lines&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>

<span class="c1"># Check if boundaries were created successfully</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">upstream_boundary</span><span class="o">.</span><span class="n">empty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">downstream_boundary</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Upstream and Downstream boundaries created successfully!&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Error: One or both boundaries are empty. Check input data.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-dis-package">
<h2>Create DIS Package<a class="headerlink" href="#create-dis-package" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------- Step 1: Ensure CRS Consistency -------------------- #</span>
<span class="k">if</span> <span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">ground_water_domain</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
    <span class="n">grid_points</span> <span class="o">=</span> <span class="n">grid_points</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">ground_water_domain</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="c1"># -------------------- Step 2: Create Model Grid Cells as Polygons -------------------- #</span>
<span class="c1"># Define grid cell polygons based on grid resolution</span>
<span class="n">grid_cells</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">cell_size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cell_size_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">cell_size_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cell_size_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">grid_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">),</span> <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span> <span class="p">(</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">)]))</span>

<span class="c1"># Convert to GeoDataFrame</span>
<span class="n">grid_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="n">grid_cells</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">ground_water_domain</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="c1"># -------------------- Step 3: Perform Spatial Join -------------------- #</span>
<span class="n">grid_gdf</span><span class="p">[</span><span class="s2">&quot;inside_domain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">ground_water_domain</span><span class="o">.</span><span class="n">unary_union</span><span class="p">)</span>

<span class="c1"># -------------------- Step 4: Initialize IDOMAIN -------------------- #</span>
<span class="n">idomain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Assign active cells where grid intersects groundwater domain</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">inside</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid_gdf</span><span class="p">[</span><span class="s2">&quot;inside_domain&quot;</span><span class="p">]):</span>
    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span>  <span class="c1"># Convert flat index to row, col</span>
    <span class="k">if</span> <span class="n">inside</span><span class="p">:</span>
        <span class="n">idomain</span><span class="p">[:,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Mark as active</span>

<span class="c1"># Debugging: Print active/inactive cell count</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Total Active Cells: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idomain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Total Inactive Cells: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idomain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># -------------------- Step 5: Visualization -------------------- #</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot IDOMAIN (First Layer)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
               <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">grid_x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Overlay Groundwater Domain</span>
<span class="c1">#ground_water_domain.boundary.plot(ax=ax, color=&quot;black&quot;, linewidth=2, label=&quot;Groundwater Domain&quot;)</span>

<span class="c1"># Axis Formatting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;IDOMAIN (1=Active, 0=Inactive)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Active and Inactive Cells Based on Groundwater Domain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Debugging: Check CRS Output</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grid Points CRS:&quot;</span><span class="p">,</span> <span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ground Water Domain CRS:&quot;</span><span class="p">,</span> <span class="n">ground_water_domain</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="c1">#print(&quot;Top Elevations 1st Layer:&quot;, tops[0])</span>
<span class="c1">#print(&quot;Bottom Elevations 1st Layer:&quot;, botm[0])</span>
<span class="c1">#print(&quot;Top Elevations:&quot;, tops)</span>
<span class="c1">#print(&quot;Bottom Elevations:&quot;, botm)</span>

<span class="c1"># Discretionize Package</span>
<span class="n">dis</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowGwfdis</span><span class="p">(</span>
    <span class="n">gwf</span><span class="p">,</span>
    <span class="n">nlay</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">botm</span><span class="p">),</span>  <span class="c1"># Number of layers (based on `botm` list length)</span>
    <span class="n">nrow</span><span class="o">=</span><span class="n">nrow</span><span class="p">,</span>       <span class="c1"># Number of rows in the grid</span>
    <span class="n">ncol</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span>       <span class="c1"># Number of columns in the grid</span>
    <span class="n">delr</span><span class="o">=</span><span class="n">cell_size_x</span><span class="p">,</span>  <span class="c1"># Cell width</span>
    <span class="n">delc</span><span class="o">=</span><span class="n">cell_size_y</span><span class="p">,</span>  <span class="c1"># Cell height</span>
    <span class="n">top</span><span class="o">=</span><span class="n">tops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>       <span class="c1"># List of dynamically calculated top elevation of the first layer</span>
    <span class="n">botm</span><span class="o">=</span><span class="n">botm</span><span class="p">,</span>          <span class="c1"># List of bottom elevations for all layers</span>
    <span class="n">idomain</span><span class="o">=</span><span class="n">idomain</span><span class="p">,</span>    <span class="c1"># List of dynamically calculated active and inactive cells in the model domain</span>
    <span class="n">xorigin</span><span class="o">=</span><span class="n">xorigin</span><span class="p">,</span>  <span class="c1"># Assign dynamically calculated xorigin</span>
    <span class="n">yorigin</span><span class="o">=</span><span class="n">yorigin</span>   <span class="c1"># Assign dynamically calculated yorigin</span>
<span class="p">)</span>
    
<span class="c1"># Add initial conditions (IC package)</span>
<span class="n">strt_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> <span class="n">bed_elevation</span><span class="p">)</span>
<span class="n">ic</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowGwfic</span><span class="p">(</span><span class="n">gwf</span><span class="p">,</span> <span class="n">strt</span><span class="o">=</span><span class="n">strt_array</span><span class="p">)</span>  <span class="c1"># Starting head set to the minimum terrain elevation for all active cells</span>

<span class="n">kh</span> <span class="o">=</span> <span class="mf">10.0</span>  <span class="c1"># Horizontal hydraulic conductivity (ft/day)</span>
<span class="n">kv</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Vertical hydraulic conductivity (ft/day)</span>

<span class="c1"># Add hydraulic properties (NPF package)</span>
<span class="n">npf</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowGwfnpf</span><span class="p">(</span>
    <span class="n">gwf</span><span class="p">,</span>
    <span class="n">k</span><span class="o">=</span><span class="n">kh</span><span class="p">,</span>  <span class="c1"># Horizontal hydraulic conductivity (ft/day)</span>
    <span class="n">k33</span><span class="o">=</span><span class="n">kv</span><span class="p">,</span>
    <span class="n">save_flows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">icelltype</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c1"># Convertable cells (0-confined, 1-convertible, 2-unconfined)</span>
    <span class="n">save_saturation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">save_specific_discharge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>

<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">dis</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="identify-boundary-cells">
<h2>Identify Boundary Cells<a class="headerlink" href="#identify-boundary-cells" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------- Step 1: Ensure CRS Consistency -------------------- #</span>
<span class="k">if</span> <span class="n">left_boundary</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
    <span class="n">left_boundary</span> <span class="o">=</span> <span class="n">left_boundary</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="k">if</span> <span class="n">right_boundary</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
    <span class="n">right_boundary</span> <span class="o">=</span> <span class="n">right_boundary</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="k">if</span> <span class="n">upstream_boundary</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
    <span class="n">upstream_boundary</span> <span class="o">=</span> <span class="n">upstream_boundary</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="k">if</span> <span class="n">downstream_boundary</span><span class="o">.</span><span class="n">crs</span> <span class="o">!=</span> <span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
    <span class="n">downstream_boundary</span> <span class="o">=</span> <span class="n">downstream_boundary</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">grid_points</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

<span class="c1"># -------------------- Step 2: Perform Spatial Join -------------------- #</span>
<span class="n">grid_gdf</span><span class="p">[</span><span class="s2">&quot;intersect_left_boundary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">left_boundary</span><span class="o">.</span><span class="n">unary_union</span><span class="p">)</span>
<span class="n">grid_gdf</span><span class="p">[</span><span class="s2">&quot;intersect_right_boundary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">right_boundary</span><span class="o">.</span><span class="n">unary_union</span><span class="p">)</span>
<span class="n">grid_gdf</span><span class="p">[</span><span class="s2">&quot;intersect_upstream_boundary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">upstream_boundary</span><span class="o">.</span><span class="n">unary_union</span><span class="p">)</span>
<span class="n">grid_gdf</span><span class="p">[</span><span class="s2">&quot;intersect_downstream_boundary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">downstream_boundary</span><span class="o">.</span><span class="n">unary_union</span><span class="p">)</span>

<span class="c1"># -------------------- Step 3: Identify Boundary Cells -------------------- #</span>
<span class="k">def</span><span class="w"> </span><span class="nf">identify_boundary_cells</span><span class="p">(</span><span class="n">idomain</span><span class="p">):</span>
    <span class="n">boundary_cells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">idomain</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">row</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span>
                    <span class="n">row</span> <span class="o">&lt;</span> <span class="n">nrow</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span>
                    <span class="n">col</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span>
                    <span class="n">col</span> <span class="o">&lt;</span> <span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlay</span><span class="p">):</span>
                        <span class="n">boundary_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">layer</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Identified </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2"> model boundary cells.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">boundary_cells</span><span class="p">)</span>

<span class="n">boundary_cells</span> <span class="o">=</span> <span class="n">identify_boundary_cells</span><span class="p">(</span><span class="n">idomain</span><span class="p">)</span>

<span class="c1"># -------------------- Step 4: Plot for Debugging -------------------- #</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot IDOMAIN (First Layer)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
               <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">grid_x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Plot Boundary Lines</span>
<span class="n">left_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left Boundary&quot;</span><span class="p">)</span>
<span class="n">right_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right Boundary&quot;</span><span class="p">)</span>
<span class="n">upstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upstream Boundary&quot;</span><span class="p">)</span>
<span class="n">downstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Downstream Boundary&quot;</span><span class="p">)</span>

<span class="c1"># Plot Boundary Cells</span>
<span class="n">boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">boundary_cells</span><span class="p">]</span>
<span class="n">boundary_cells_x</span><span class="p">,</span> <span class="n">boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">boundary_cells_coords</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">boundary_cells_x</span><span class="p">,</span> <span class="n">boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Axis Formatting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;IDOMAIN (1=Active, 0=Inactive)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Boundary Lines and Boundary Cells&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># -------------------- Step 5: Identify Cells with Minimum Distance to Each Boundary -------------------- #</span>
<span class="k">def</span><span class="w"> </span><span class="nf">classify_boundary_cells</span><span class="p">(</span><span class="n">boundary_cells</span><span class="p">,</span> <span class="n">grid_gdf</span><span class="p">,</span> <span class="n">left_boundary</span><span class="p">,</span> <span class="n">right_boundary</span><span class="p">,</span> <span class="n">upstream_boundary</span><span class="p">,</span> <span class="n">downstream_boundary</span><span class="p">):</span>
    <span class="n">classified_cells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">left_boundary_cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">right_boundary_cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">upstream_boundary_cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">downstream_boundary_cells</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">boundary_cells</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="ow">in</span> <span class="n">classified_cells</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># Skip already classified cells</span>

        <span class="n">cell</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">left_boundary</span><span class="o">.</span><span class="n">unary_union</span><span class="p">),</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">right_boundary</span><span class="o">.</span><span class="n">unary_union</span><span class="p">),</span>
            <span class="s2">&quot;upstream&quot;</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">upstream_boundary</span><span class="o">.</span><span class="n">unary_union</span><span class="p">),</span>
            <span class="s2">&quot;downstream&quot;</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">downstream_boundary</span><span class="o">.</span><span class="n">unary_union</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">closest_boundary</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">distances</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">closest_boundary</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
            <span class="n">left_boundary_cells</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">layer</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">closest_boundary</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span>
            <span class="n">right_boundary_cells</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">layer</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">closest_boundary</span> <span class="o">==</span> <span class="s2">&quot;upstream&quot;</span><span class="p">:</span>
            <span class="n">upstream_boundary_cells</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">layer</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">closest_boundary</span> <span class="o">==</span> <span class="s2">&quot;downstream&quot;</span><span class="p">:</span>
            <span class="n">downstream_boundary_cells</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">layer</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>

        <span class="n">classified_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">layer</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>  <span class="c1"># Mark cell as classified</span>

    <span class="k">return</span> <span class="n">left_boundary_cells</span><span class="p">,</span> <span class="n">right_boundary_cells</span><span class="p">,</span> <span class="n">upstream_boundary_cells</span><span class="p">,</span> <span class="n">downstream_boundary_cells</span>

<span class="n">left_boundary_cells</span><span class="p">,</span> <span class="n">right_boundary_cells</span><span class="p">,</span> <span class="n">upstream_boundary_cells</span><span class="p">,</span> <span class="n">downstream_boundary_cells</span> <span class="o">=</span> <span class="n">classify_boundary_cells</span><span class="p">(</span>
    <span class="n">boundary_cells</span><span class="p">,</span> <span class="n">grid_gdf</span><span class="p">,</span> <span class="n">left_boundary</span><span class="p">,</span> <span class="n">right_boundary</span><span class="p">,</span> <span class="n">upstream_boundary</span><span class="p">,</span> <span class="n">downstream_boundary</span>
<span class="p">)</span>

<span class="c1"># Combine all boundary cells into a single list</span>
<span class="n">all_boundary_cells</span> <span class="o">=</span> <span class="n">left_boundary_cells</span> <span class="o">+</span> <span class="n">right_boundary_cells</span> <span class="o">+</span> <span class="n">upstream_boundary_cells</span> <span class="o">+</span> <span class="n">downstream_boundary_cells</span>

<span class="c1"># Print the number of boundary cells identified for each boundary type</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Left Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">left_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Right Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">right_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Upstream Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">upstream_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Downstream Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">downstream_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Check for duplicates in the combined boundary cells</span>
<span class="n">unique_boundary_cells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_boundary_cells</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_boundary_cells</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_boundary_cells</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_boundary_cells</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">unique_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate entries in combined boundary cells.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No duplicate entries found in combined boundary cells.&quot;</span><span class="p">)</span>

<span class="c1"># Print the total number of unique boundary cells</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Total Unique Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Print the number of cells for each boundary type in the first layer</span>
<span class="n">left_boundary_cells_first_layer</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">left_boundary_cells</span> <span class="k">if</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">right_boundary_cells_first_layer</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">right_boundary_cells</span> <span class="k">if</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">upstream_boundary_cells_first_layer</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">upstream_boundary_cells</span> <span class="k">if</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">downstream_boundary_cells_first_layer</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">downstream_boundary_cells</span> <span class="k">if</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># Should match the amount of boundary cells identified in the first layer</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Left Boundary Cells (First Layer): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">left_boundary_cells_first_layer</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Right Boundary Cells (First Layer): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">right_boundary_cells_first_layer</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Upstream Boundary Cells (First Layer): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">upstream_boundary_cells_first_layer</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Downstream Boundary Cells (First Layer): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">downstream_boundary_cells_first_layer</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># -------------------- Step 6: Plot Classified Boundary Cells -------------------- #</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot IDOMAIN (First Layer)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
               <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">grid_x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Plot Boundary Lines</span>
<span class="n">left_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left Boundary&quot;</span><span class="p">)</span>
<span class="n">right_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right Boundary&quot;</span><span class="p">)</span>
<span class="n">upstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upstream Boundary&quot;</span><span class="p">)</span>
<span class="n">downstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Downstream Boundary&quot;</span><span class="p">)</span>

<span class="c1"># Plot Classified Boundary Cells</span>
<span class="n">left_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">left_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">right_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">right_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">upstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">upstream_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">downstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">downstream_boundary_cells_first_layer</span><span class="p">]</span>

<span class="n">left_boundary_cells_x</span><span class="p">,</span> <span class="n">left_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">left_boundary_cells_coords</span><span class="p">)</span>
<span class="n">right_boundary_cells_x</span><span class="p">,</span> <span class="n">right_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">right_boundary_cells_coords</span><span class="p">)</span>
<span class="n">upstream_boundary_cells_x</span><span class="p">,</span> <span class="n">upstream_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">upstream_boundary_cells_coords</span><span class="p">)</span>
<span class="n">downstream_boundary_cells_x</span><span class="p">,</span> <span class="n">downstream_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">downstream_boundary_cells_coords</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">left_boundary_cells_x</span><span class="p">,</span> <span class="n">left_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">right_boundary_cells_x</span><span class="p">,</span> <span class="n">right_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">upstream_boundary_cells_x</span><span class="p">,</span> <span class="n">upstream_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upstream Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">downstream_boundary_cells_x</span><span class="p">,</span> <span class="n">downstream_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Downstream Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Axis Formatting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;IDOMAIN (1=Active, 0=Inactive)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Classified Boundary Cells&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="find-ground-water-elevation">
<h2>Find Ground Water Elevation<a class="headerlink" href="#find-ground-water-elevation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -------------------- Assign Surface Water Elevations -------------------- #</span>
<span class="c1"># Plot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rasterio.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">rowcol</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1">## Visualize Data</span>
<span class="c1"># Plot the raster of surface elevation over the model domain</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the raster surface elevation</span>
<span class="n">plt_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> 
              <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cropped_surface_elevation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
              <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">cropped_surface_elevation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
<span class="n">elevation_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">cropped_surface_elevation</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="n">plt_extent</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
<span class="p">)</span>

<span class="c1"># Add the model grid points</span>
<span class="c1">#grid_points.plot(ax=ax, color=&quot;blue&quot;, markersize=1, label=&quot;Model Grid Points&quot;)</span>

<span class="c1"># Add the raster bounds for reference</span>
<span class="n">raster_bounds_gdf</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Raster Bounds&quot;</span><span class="p">)</span>

<span class="c1"># Add a colorbar for the raster</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">elevation_plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Surface Water Elevation (ft)&quot;</span><span class="p">)</span>

<span class="c1"># Plot Boundary Lines</span>
<span class="n">left_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left Boundary&quot;</span><span class="p">)</span>
<span class="n">right_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right Boundary&quot;</span><span class="p">)</span>
<span class="n">upstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upstream Boundary&quot;</span><span class="p">)</span>
<span class="n">downstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Downstream Boundary&quot;</span><span class="p">)</span>

<span class="c1"># Plot Classified Boundary Cells</span>
<span class="n">left_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">left_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">right_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">right_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">upstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">upstream_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">downstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">downstream_boundary_cells_first_layer</span><span class="p">]</span>

<span class="n">left_boundary_cells_x</span><span class="p">,</span> <span class="n">left_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">left_boundary_cells_coords</span><span class="p">)</span>
<span class="n">right_boundary_cells_x</span><span class="p">,</span> <span class="n">right_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">right_boundary_cells_coords</span><span class="p">)</span>
<span class="n">upstream_boundary_cells_x</span><span class="p">,</span> <span class="n">upstream_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">upstream_boundary_cells_coords</span><span class="p">)</span>
<span class="n">downstream_boundary_cells_x</span><span class="p">,</span> <span class="n">downstream_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">downstream_boundary_cells_coords</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">left_boundary_cells_x</span><span class="p">,</span> <span class="n">left_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">right_boundary_cells_x</span><span class="p">,</span> <span class="n">right_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">upstream_boundary_cells_x</span><span class="p">,</span> <span class="n">upstream_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upstream Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">downstream_boundary_cells_x</span><span class="p">,</span> <span class="n">downstream_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Downstream Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Customize the plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Water Elevation Over Model Domain&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Set NA values to a default value of bed elevation</span>
<span class="c1"># Define the grid points (assuming grid_points is a GeoDataFrame with &#39;geometry&#39; column)</span>
<span class="n">grid_points_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">grid_points</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>

<span class="c1"># Extract elevation values at grid points</span>
<span class="n">elevation_values</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cropped_output_raster</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">grid_points_coords</span><span class="p">:</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">rowcol</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
            <span class="n">elevation</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">elevation_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elevation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">elevation_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Append None if the point is out of bounds</span>

<span class="c1"># Create a DataFrame with the grid points and their corresponding elevation values</span>
<span class="n">grid_points_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">grid_points_coords</span><span class="p">],</span>
    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">grid_points_coords</span><span class="p">],</span>
    <span class="s1">&#39;elevation&#39;</span><span class="p">:</span> <span class="n">elevation_values</span>
<span class="p">})</span>

<span class="c1"># Save the DataFrame to a CSV file</span>
<span class="n">output_csv</span> <span class="o">=</span> <span class="s2">&quot;grid_points_elevation.csv&quot;</span>
<span class="n">grid_points_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid points elevation values saved as </span><span class="si">{</span><span class="n">output_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Read the CSV file</span>
<span class="n">grid_points_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">)</span>

<span class="c1"># Function to get max elevation for boundary cells</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_max_elevation</span><span class="p">(</span><span class="n">boundary_cells_coords</span><span class="p">,</span> <span class="n">grid_points_df</span><span class="p">):</span>
    <span class="n">elevations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">boundary_cells_coords</span><span class="p">:</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="n">grid_points_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">grid_points_df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">grid_points_df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="p">),</span> <span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">elevation</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elevations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elevation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">elevations</span><span class="p">)</span> <span class="k">if</span> <span class="n">elevations</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># Find matching coordinates for boundary cells</span>
<span class="n">upstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">upstream_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">downstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">downstream_boundary_cells_first_layer</span><span class="p">]</span>

<span class="c1"># Calculate max surface water elevation for upstream and downstream boundary cells</span>
<span class="n">max_elevation_upstream</span> <span class="o">=</span> <span class="n">get_max_elevation</span><span class="p">(</span><span class="n">upstream_boundary_cells_coords</span><span class="p">,</span> <span class="n">grid_points_df</span><span class="p">)</span>
<span class="n">max_elevation_downstream</span> <span class="o">=</span> <span class="n">get_max_elevation</span><span class="p">(</span><span class="n">downstream_boundary_cells_coords</span><span class="p">,</span> <span class="n">grid_points_df</span><span class="p">)</span>

<span class="c1"># Print max elevations</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max Elevation Upstream Boundary:&quot;</span><span class="p">,</span> <span class="n">max_elevation_upstream</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max Elevation Downstream Boundary:&quot;</span><span class="p">,</span> <span class="n">max_elevation_downstream</span><span class="p">)</span>

<span class="c1"># Plot the raster of surface elevation over the model domain</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot the raster surface elevation</span>
<span class="n">plt_extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> 
              <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cropped_surface_elevation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
              <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">cropped_surface_elevation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="n">cropped_surface_transform</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
<span class="n">elevation_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">cropped_surface_elevation</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="n">plt_extent</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
<span class="p">)</span>

<span class="c1"># Add the model grid points</span>
<span class="c1">#grid_points.plot(ax=ax, color=&quot;blue&quot;, markersize=1, label=&quot;Model Grid Points&quot;)</span>

<span class="c1"># Add the raster bounds for reference</span>
<span class="n">raster_bounds_gdf</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Raster Bounds&quot;</span><span class="p">)</span>

<span class="c1"># Add a colorbar for the raster</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">elevation_plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Surface Water Elevation (ft)&quot;</span><span class="p">)</span>

<span class="c1"># Plot Boundary Lines</span>
<span class="n">left_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left Boundary&quot;</span><span class="p">)</span>
<span class="n">right_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right Boundary&quot;</span><span class="p">)</span>
<span class="n">upstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upstream Boundary&quot;</span><span class="p">)</span>
<span class="n">downstream_boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Downstream Boundary&quot;</span><span class="p">)</span>

<span class="c1"># Plot Classified Boundary Cells</span>
<span class="n">left_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">left_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">right_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">right_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">upstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">upstream_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">downstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">downstream_boundary_cells_first_layer</span><span class="p">]</span>

<span class="n">left_boundary_cells_x</span><span class="p">,</span> <span class="n">left_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">left_boundary_cells_coords</span><span class="p">)</span>
<span class="n">right_boundary_cells_x</span><span class="p">,</span> <span class="n">right_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">right_boundary_cells_coords</span><span class="p">)</span>
<span class="n">upstream_boundary_cells_x</span><span class="p">,</span> <span class="n">upstream_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">upstream_boundary_cells_coords</span><span class="p">)</span>
<span class="n">downstream_boundary_cells_x</span><span class="p">,</span> <span class="n">downstream_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">downstream_boundary_cells_coords</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">left_boundary_cells_x</span><span class="p">,</span> <span class="n">left_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">right_boundary_cells_x</span><span class="p">,</span> <span class="n">right_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">upstream_boundary_cells_x</span><span class="p">,</span> <span class="n">upstream_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upstream Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">downstream_boundary_cells_x</span><span class="p">,</span> <span class="n">downstream_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Downstream Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Customize the plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Water Elevation Over Model Domain&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Longitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="assign-constant-head-to-boundary-conditions">
<h2>Assign Constant Head to Boundary Conditions<a class="headerlink" href="#assign-constant-head-to-boundary-conditions" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assign Ground Water Elevation to Boundary Cells</span>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_gw_elevation</span><span class="p">(</span><span class="n">boundary_cells</span><span class="p">,</span> <span class="n">top_elevation</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="n">gw_elevation_min</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">boundary_cells</span><span class="p">:</span>
        <span class="n">layer</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="n">gw_elevation</span> <span class="o">=</span> <span class="n">top_elevation</span> <span class="o">+</span> <span class="n">offset</span>  <span class="c1"># Simply add the offset to the scalar top_elevation</span>
        <span class="n">gw_elevation_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gw_elevation</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gw_elevation_min</span>

<span class="n">gw_offset</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Offset value for groundwater elevation</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">gw_offset</span>  <span class="c1"># Offset value for groundwater elevation</span>

<span class="c1"># Identify first and last cell for each boundary</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_boundary_first_last</span><span class="p">(</span><span class="n">boundary_cells</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">boundary_cells</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">boundary_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boundary_cells</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">left_boundary_first</span><span class="p">,</span> <span class="n">left_boundary_last</span> <span class="o">=</span> <span class="n">get_boundary_first_last</span><span class="p">(</span><span class="n">left_boundary_cells_first_layer</span><span class="p">)</span>
<span class="n">right_boundary_first</span><span class="p">,</span> <span class="n">right_boundary_last</span> <span class="o">=</span> <span class="n">get_boundary_first_last</span><span class="p">(</span><span class="n">right_boundary_cells_first_layer</span><span class="p">)</span>
<span class="n">upstream_boundary_first</span><span class="p">,</span> <span class="n">upstream_boundary_last</span> <span class="o">=</span> <span class="n">get_boundary_first_last</span><span class="p">(</span><span class="n">upstream_boundary_cells_first_layer</span><span class="p">)</span>
<span class="n">downstream_boundary_first</span><span class="p">,</span> <span class="n">downstream_boundary_last</span> <span class="o">=</span> <span class="n">get_boundary_first_last</span><span class="p">(</span><span class="n">downstream_boundary_cells_first_layer</span><span class="p">)</span>

<span class="c1"># Calculate groundwater elevations for each boundary</span>
<span class="n">gw_elevation_left_first</span> <span class="o">=</span> <span class="n">calculate_gw_elevation</span><span class="p">([</span><span class="n">left_boundary_first</span><span class="p">],</span> <span class="n">max_elevation_upstream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gw_elevation_left_last</span> <span class="o">=</span> <span class="n">calculate_gw_elevation</span><span class="p">([</span><span class="n">left_boundary_last</span><span class="p">],</span> <span class="n">max_elevation_downstream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">gw_elevation_right_first</span> <span class="o">=</span> <span class="n">calculate_gw_elevation</span><span class="p">([</span><span class="n">right_boundary_first</span><span class="p">],</span> <span class="n">max_elevation_upstream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gw_elevation_right_last</span> <span class="o">=</span> <span class="n">calculate_gw_elevation</span><span class="p">([</span><span class="n">right_boundary_last</span><span class="p">],</span> <span class="n">max_elevation_downstream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">gw_elevation_upstream_first</span> <span class="o">=</span> <span class="n">calculate_gw_elevation</span><span class="p">([</span><span class="n">upstream_boundary_first</span><span class="p">],</span> <span class="n">max_elevation_upstream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gw_elevation_upstream_last</span> <span class="o">=</span> <span class="n">calculate_gw_elevation</span><span class="p">([</span><span class="n">upstream_boundary_last</span><span class="p">],</span> <span class="n">max_elevation_upstream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">gw_elevation_downstream_first</span> <span class="o">=</span> <span class="n">calculate_gw_elevation</span><span class="p">([</span><span class="n">downstream_boundary_first</span><span class="p">],</span> <span class="n">max_elevation_downstream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gw_elevation_downstream_last</span> <span class="o">=</span> <span class="n">calculate_gw_elevation</span><span class="p">([</span><span class="n">downstream_boundary_last</span><span class="p">],</span> <span class="n">max_elevation_downstream</span><span class="p">,</span> <span class="n">offset</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Debugging: Print the calculated groundwater elevations</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Left Boundary Groundwater Elevation First:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_left_first</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Left Boundary Groundwater Elevation Last:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_left_last</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Right Boundary Groundwater Elevation First:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_right_first</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Right Boundary Groundwater Elevation Last:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_right_last</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Upstream Boundary Groundwater Elevation First:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_upstream_first</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Upstream Boundary Groundwater Elevation Last:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_upstream_last</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downstream Boundary Groundwater Elevation First:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_downstream_first</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downstream Boundary Groundwater Elevation Last:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_downstream_last</span><span class="p">)</span>

<span class="c1"># Interpolate Groundwater Elevation Across Boundary Cells</span>
<span class="k">def</span><span class="w"> </span><span class="nf">interpolate_gw_elevation</span><span class="p">(</span><span class="n">boundary_cells</span><span class="p">,</span> <span class="n">gw_elevation_first</span><span class="p">,</span> <span class="n">gw_elevation_last</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_cells</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">gw_elevation_first</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
    <span class="n">interpolated_gw_elevations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">interpolated_value</span> <span class="o">=</span> <span class="n">gw_elevation_first</span> <span class="o">+</span> <span class="p">(</span><span class="n">gw_elevation_last</span> <span class="o">-</span> <span class="n">gw_elevation_first</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">interpolated_gw_elevations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolated_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interpolated_gw_elevations</span>

<span class="c1"># Interpolate groundwater elevations for each boundary</span>
<span class="n">gw_elevation_left</span> <span class="o">=</span> <span class="n">interpolate_gw_elevation</span><span class="p">(</span><span class="n">left_boundary_cells</span><span class="p">,</span> <span class="n">gw_elevation_left_first</span><span class="p">,</span> <span class="n">gw_elevation_left_last</span><span class="p">)</span>
<span class="n">gw_elevation_right</span> <span class="o">=</span> <span class="n">interpolate_gw_elevation</span><span class="p">(</span><span class="n">right_boundary_cells</span><span class="p">,</span> <span class="n">gw_elevation_right_first</span><span class="p">,</span> <span class="n">gw_elevation_right_last</span><span class="p">)</span>
<span class="n">gw_elevation_upstream</span> <span class="o">=</span> <span class="n">interpolate_gw_elevation</span><span class="p">(</span><span class="n">upstream_boundary_cells</span><span class="p">,</span> <span class="n">gw_elevation_upstream_first</span><span class="p">,</span> <span class="n">gw_elevation_upstream_last</span><span class="p">)</span>
<span class="n">gw_elevation_downstream</span> <span class="o">=</span> <span class="n">interpolate_gw_elevation</span><span class="p">(</span><span class="n">downstream_boundary_cells</span><span class="p">,</span> <span class="n">gw_elevation_downstream_first</span><span class="p">,</span> <span class="n">gw_elevation_downstream_last</span><span class="p">)</span>

<span class="c1"># Debugging: Print the interpolated groundwater elevations</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Left Boundary Groundwater Elevations:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_left</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Right Boundary Groundwater Elevations:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_right</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Upstream Boundary Groundwater Elevations:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_upstream</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downstream Boundary Groundwater Elevations:&quot;</span><span class="p">,</span> <span class="n">gw_elevation_downstream</span><span class="p">)</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Plot the groundwater elevation in only the active cells and highlight the boundary cells</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Plot elevation for active cells</span>
<span class="n">active_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">top_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_active</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
               <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">grid_x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Plot Classified Boundary Cells</span>
<span class="n">left_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">left_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">right_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">right_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">upstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">upstream_boundary_cells_first_layer</span><span class="p">]</span>
<span class="n">downstream_boundary_cells_coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">grid_x</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">grid_y</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">downstream_boundary_cells_first_layer</span><span class="p">]</span>

<span class="n">left_boundary_cells_x</span><span class="p">,</span> <span class="n">left_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">left_boundary_cells_coords</span><span class="p">)</span>
<span class="n">right_boundary_cells_x</span><span class="p">,</span> <span class="n">right_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">right_boundary_cells_coords</span><span class="p">)</span>
<span class="n">upstream_boundary_cells_x</span><span class="p">,</span> <span class="n">upstream_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">upstream_boundary_cells_coords</span><span class="p">)</span>
<span class="n">downstream_boundary_cells_x</span><span class="p">,</span> <span class="n">downstream_boundary_cells_y</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">downstream_boundary_cells_coords</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">left_boundary_cells_x</span><span class="p">,</span> <span class="n">left_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">right_boundary_cells_x</span><span class="p">,</span> <span class="n">right_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">upstream_boundary_cells_x</span><span class="p">,</span> <span class="n">upstream_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upstream Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">downstream_boundary_cells_x</span><span class="p">,</span> <span class="n">downstream_boundary_cells_y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Downstream Boundary Cells&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Axis Formatting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Elevation (ft)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Terrain Elevation and Classified Boundary Cells&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;X Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Y Coordinate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-the-constant-head-boundary-package">
<h2>Create the Constant Head Boundary Package<a class="headerlink" href="#create-the-constant-head-boundary-package" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the CHD package</span>
<span class="n">chd_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Identify boundary cells where the elevations are &lt;= groundwater elevations</span>
<span class="n">ch_left_boundary</span> <span class="o">=</span> <span class="n">gw_elevation_left</span>  <span class="c1"># Groundwater elevation list matching the left boundary cells (nlay, nrow, ncol)</span>
<span class="n">ch_right_boundary</span> <span class="o">=</span> <span class="n">gw_elevation_right</span>  <span class="c1"># Groundwater elevation list matching the right boundary cells (nlay, nrow, ncol)</span>
<span class="n">ch_upstream_boundary</span> <span class="o">=</span> <span class="n">gw_elevation_upstream</span>  <span class="c1"># Groundwater elevation list matching the upstream boundary cells (nlay, nrow, ncol)</span>
<span class="n">ch_downstream_boundary</span> <span class="o">=</span> <span class="n">gw_elevation_downstream</span>  <span class="c1"># Groundwater elevation list matching the downstream boundary cells (nlay, nrow, ncol)</span>

<span class="c1"># Set to keep track of unique (nlay, nrow, ncol) coordinates</span>
<span class="n">unique_chd_cells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">duplicate_chd_cells</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="c1"># Add boundary conditions for each side of the model and track duplicates</span>

<span class="c1"># Left Boundaries (Constant Head = ch_left_boundary)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">left_boundary_cells</span><span class="p">):</span>
    <span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Extract nlay, nrow, ncol</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_chd_cells</span><span class="p">:</span>
        <span class="n">chd_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">ch_left_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">unique_chd_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>  <span class="c1"># Add to unique set</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">duplicate_chd_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>  <span class="c1"># Track duplicate cells</span>

<span class="c1"># Right Boundaries (Constant Head = ch_right_boundary)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">right_boundary_cells</span><span class="p">):</span>
    <span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Extract nlay, nrow, ncol</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_chd_cells</span><span class="p">:</span>
        <span class="n">chd_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">ch_right_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">unique_chd_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>  <span class="c1"># Add to unique set</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">duplicate_chd_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>  <span class="c1"># Track duplicate cells</span>

<span class="c1"># Upstream Boundary (Constant Head = ch_upstream_boundary)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">upstream_boundary_cells</span><span class="p">):</span>
    <span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Extract nlay, nrow, ncol</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_chd_cells</span><span class="p">:</span>
        <span class="n">chd_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">ch_upstream_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">unique_chd_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>  <span class="c1"># Add to unique set</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">duplicate_chd_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>  <span class="c1"># Track duplicate cells</span>

<span class="c1"># Downstream Boundary (Constant Head = ch_downstream_boundary)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">downstream_boundary_cells</span><span class="p">):</span>
    <span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Extract nlay, nrow, ncol</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_chd_cells</span><span class="p">:</span>
        <span class="n">chd_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">ch_downstream_boundary</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">unique_chd_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>  <span class="c1"># Add to unique set</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">duplicate_chd_cells</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>  <span class="c1"># Track duplicate cells</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Total Unique CHD Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_chd_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Total Duplicate CHD Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">duplicate_chd_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Convert np.float32 to standard Python float</span>
<span class="n">chd_data_converted</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chd_data</span><span class="p">:</span>
    <span class="c1"># Check if item[3] is a list and convert each element to float</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">converted_head_value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">converted_head_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    
    <span class="n">converted_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">converted_head_value</span><span class="p">]</span>
    <span class="n">chd_data_converted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">converted_item</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Assigned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">chd_data_converted</span><span class="p">)</span><span class="si">}</span><span class="s2"> CHD boundary cells.&quot;</span><span class="p">)</span>

<span class="c1"># Assign CHD Package to the model if there are valid unique boundary cells</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">chd_data_converted</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No CHD boundary cells assigned. Please check the input data and conditions.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Format the CHD values to ensure they are not in scientific notation</span>
    <span class="n">formatted_chd_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chd_data_converted</span>
    <span class="p">]</span>
    
    <span class="c1"># Assuming &#39;gwf&#39; is your groundwater flow model instance</span>
    <span class="n">chd</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowGwfchd</span><span class="p">(</span>
        <span class="n">gwf</span><span class="p">,</span>
        <span class="n">maxbound</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">formatted_chd_data</span><span class="p">),</span>  <span class="c1"># Set to actual assigned CHD cells</span>
        <span class="n">stress_period_data</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">formatted_chd_data</span><span class="p">},</span>  <span class="c1"># Apply the boundary conditions in stress period 0</span>
        <span class="n">pname</span><span class="o">=</span><span class="s2">&quot;CHD&quot;</span><span class="p">,</span>
        <span class="n">save_flows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.chd&quot;</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Assigned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">formatted_chd_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique CHD boundary cells.&quot;</span><span class="p">)</span>

<span class="c1"># Optional: print the boundary cell counts</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Left Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">left_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Right Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">right_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upstream Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">upstream_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downstream Boundary Cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">downstream_boundary_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="recharge-package">
<h2>Recharge Package<a class="headerlink" href="#recharge-package" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add Recharge Package</span>
<span class="n">rch</span> <span class="o">=</span> <span class="mf">0.005</span>  <span class="c1"># Recharge rate ($ft/d$)</span>
<span class="n">rch</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowGwfrcha</span><span class="p">(</span><span class="n">gwf</span><span class="p">,</span> <span class="n">recharge</span><span class="o">=</span><span class="n">rch</span><span class="p">,</span> <span class="n">save_flows</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Recharge rate set to 0.05 ft/day</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="add-wells">
<h2>Add Wells<a class="headerlink" href="#add-wells" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the bounds of the shapefile</span>
<span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">ground_water_domain</span><span class="o">.</span><span class="n">total_bounds</span>

<span class="c1"># Function to generate a random point within the bounds</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_random_point_within</span><span class="p">(</span><span class="n">bounds</span><span class="p">):</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">bounds</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pnt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">miny</span><span class="p">,</span> <span class="n">maxy</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ground_water_domain</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">pnt</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">pnt</span>

<span class="c1"># Generate 3 random points within the shapefile</span>
<span class="n">random_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">generate_random_point_within</span><span class="p">((</span><span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

<span class="c1"># Assign pseudo pumping rates to these points</span>
<span class="n">pumping_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Example pseudo pumping rates</span>

<span class="c1"># Create a GeoDataFrame with the well locations and pumping rates</span>
<span class="n">well_data</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">point</span><span class="p">,</span> <span class="s1">&#39;pump_rate&#39;</span><span class="p">:</span> <span class="n">rate</span><span class="p">}</span> <span class="k">for</span> <span class="n">point</span><span class="p">,</span> <span class="n">rate</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">random_points</span><span class="p">,</span> <span class="n">pumping_rates</span><span class="p">)]</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">well_data</span><span class="p">)</span>

<span class="c1"># Print the GeoDataFrame</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>

<span class="c1"># Save the GeoDataFrame as a shapefile</span>
<span class="n">output_shapefile</span> <span class="o">=</span> <span class="s1">&#39;random_wells.shp&#39;</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">output_shapefile</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random wells shapefile saved as </span><span class="si">{</span><span class="n">output_shapefile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plot elevation for active cells</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Mask inactive cells in the elevation data</span>
<span class="n">top_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>

<span class="c1"># Plot the elevation data for active cells</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_active</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
               <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">grid_x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Add a colorbar</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Elevation (m)&#39;</span><span class="p">)</span>

<span class="c1"># Overlay the selected wells</span>
<span class="c1"># Extract x and y coordinates of the selected wells</span>
<span class="n">selected_cells_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">random_points</span><span class="p">]</span>
<span class="n">selected_cells_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">random_points</span><span class="p">]</span>

<span class="c1"># Overlay the selected wells</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">selected_cells_x</span><span class="p">,</span> <span class="n">selected_cells_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Selected Wells&#39;</span><span class="p">)</span>
<span class="c1"># Add labels and legend</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Column Index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Row Index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Elevation and Selected Wells&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">## Read in Actual Point Shapefile (coordinates of wells + well pumping rates)</span>
<span class="c1"># Define the path to your point file</span>
<span class="n">point_file_path</span> <span class="o">=</span> <span class="s1">&#39;random_wells.shp&#39;</span>  <span class="c1"># Replace with the actual path to your point file</span>

<span class="c1"># Read the point file using geopandas</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">point_file_path</span><span class="p">)</span>

<span class="c1"># Reproject the point file to the target CRS</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">hec_ras_crs</span><span class="p">)</span>

<span class="c1"># Print the GeoDataFrame</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>

<span class="c1"># Extract well locations and pumping rates</span>
<span class="n">well_locations</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
<span class="n">pumping_rates</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="s1">&#39;pump_rate&#39;</span><span class="p">]</span>

<span class="c1"># Print well locations and pumping rates</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Well Locations:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">well_locations</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pumping Rates:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pumping_rates</span><span class="p">)</span>

<span class="c1"># Print well locations and pumping rates</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Well Locations:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">well_locations</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pumping Rates:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pumping_rates</span><span class="p">)</span>

<span class="c1"># Define the transform for converting coordinates to model grid indices</span>
<span class="c1"># Replace with your actual transform</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">from_origin</span><span class="p">(</span><span class="n">xorigin</span><span class="p">,</span> <span class="n">yorigin</span><span class="p">,</span> <span class="n">cell_size_x</span><span class="p">,</span> <span class="n">cell_size_y</span><span class="p">)</span>

<span class="c1"># Create the well package data</span>
<span class="n">wel_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">idomain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">idomain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">well_geometry</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">well_geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">well_geometry</span><span class="o">.</span><span class="n">y</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="o">~</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># Convert coordinates to model grid indices</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>  <span class="c1"># Ensure indices are integers</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Assuming wells are in the first layer</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;pump_rate&#39;</span><span class="p">]</span>  <span class="c1"># Pull the pumping rate from the point file attribute</span>

    <span class="c1"># Check if the well point intersects any cell in the grid</span>
    <span class="k">for</span> <span class="n">grid_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">grid_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
            <span class="n">cell_geometry</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">grid_row</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">grid_col</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span>
            <span class="k">if</span> <span class="n">well_geometry</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">cell_geometry</span><span class="p">):</span>
                <span class="n">wel_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">grid_row</span><span class="p">,</span> <span class="n">grid_col</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">q</span><span class="p">)])</span>
                <span class="k">break</span>  <span class="c1"># Exit the loop once the intersecting cell is found</span>

<span class="c1"># Print the well package data for verification</span>
<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">wel_data</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

<span class="c1"># Create the well package</span>
<span class="n">wel</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowGwfwel</span><span class="p">(</span>
    <span class="n">gwf</span><span class="p">,</span>
    <span class="n">stress_period_data</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">wel_data</span><span class="p">},</span>
    <span class="n">pname</span><span class="o">=</span><span class="s1">&#39;WEL&#39;</span>
<span class="p">)</span>

<span class="c1"># Monitoring strategy</span>
<span class="k">def</span><span class="w"> </span><span class="nf">monitor_wells</span><span class="p">(</span><span class="n">wel_data</span><span class="p">):</span>
    <span class="c1"># Example monitoring strategy: Print well locations and pumping rates</span>
    <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">wel_data</span><span class="p">:</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">well</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monitoring Well at Layer </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">, Row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, Column </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> with Pumping Rate </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2"> cubic feet per day&quot;</span><span class="p">)</span>

<span class="c1"># Implement monitoring strategy</span>
<span class="n">monitor_wells</span><span class="p">(</span><span class="n">wel_data</span><span class="p">)</span>

<span class="c1"># Plot the model grid and well locations</span>
<span class="c1"># Plot elevation for active cells again with the wells from the well package</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot the elevation data for active cells</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_active</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
               <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">grid_x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">grid_y</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># Add a colorbar</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Elevation (m)&#39;</span><span class="p">)</span>

<span class="c1"># Overlay the wells from the well package</span>
<span class="c1"># Extract x and y coordinates of the wells</span>
<span class="n">well_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
<span class="n">well_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>

<span class="c1"># Overlay the wells</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">well_x</span><span class="p">,</span> <span class="n">well_y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Wells from Well Package&#39;</span><span class="p">)</span>

<span class="c1"># Add labels and legend</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Column Index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Row Index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Elevation and Wells from Well Package&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Show the plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="identify-river-cells">
<h2>Identify River Cells<a class="headerlink" href="#identify-river-cells" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#----------------------Define Any River Cells ------------------------#</span>
<span class="c1"># Read the CSV file</span>
<span class="n">grid_points_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">)</span>

<span class="c1"># Print the first few rows of the dataframe</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grid_points_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1"># Filter out rows with NaN values in the elevation column</span>
<span class="n">grid_points_df</span> <span class="o">=</span> <span class="n">grid_points_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">])</span>

<span class="c1"># Remove rows where elevation is -9999</span>
<span class="n">grid_points_df</span> <span class="o">=</span> <span class="n">grid_points_df</span><span class="p">[</span><span class="n">grid_points_df</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">grid_points_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1"># Plot the river cells</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">grid_points_df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">grid_points_df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">grid_points_df</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Elevation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;River Cells&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X Coordinate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y Coordinate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Define river parameters</span>
<span class="n">riv_z</span> <span class="o">=</span> <span class="n">bed_elevation</span>   <span class="c1"># River bed elevation in feet (example value, adjust as needed)</span>

<span class="c1"># Initialize an empty list for river data</span>
<span class="n">rd</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Get the shape of the model domain</span>
<span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">idomain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">idomain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># Define the transform for converting coordinates to model grid indices</span>
<span class="c1"># Replace with your actual transform</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">from_origin</span><span class="p">(</span><span class="n">xorigin</span><span class="p">,</span> <span class="n">yorigin</span><span class="p">,</span> <span class="n">cell_size_x</span><span class="p">,</span> <span class="n">cell_size_y</span><span class="p">)</span>

<span class="c1"># Iterate through the model grid to create the river data</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">grid_points_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="o">~</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># Convert coordinates to model grid indices</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>  <span class="c1"># Ensure indices are integers</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Assuming river cells are in the first layer</span>
    <span class="n">riv_h</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span>  <span class="c1"># Pull the elevation from the DataFrame</span>

    <span class="c1"># Check if the cell is active in the first layer</span>
    <span class="k">if</span> <span class="n">idomain</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Check if the well point intersects any cell in the grid</span>
        <span class="k">for</span> <span class="n">grid_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">grid_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
                <span class="n">cell_geometry</span> <span class="o">=</span> <span class="n">grid_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">grid_row</span> <span class="o">*</span> <span class="n">ncol</span> <span class="o">+</span> <span class="n">grid_col</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span>
                <span class="k">if</span> <span class="n">well_geometry</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">cell_geometry</span><span class="p">):</span>
                    <span class="n">rd</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">grid_row</span><span class="p">,</span> <span class="n">grid_col</span><span class="p">),</span> <span class="n">riv_h</span><span class="p">,</span> <span class="n">riv_c</span><span class="p">,</span> <span class="n">riv_z</span><span class="p">,</span> <span class="n">riv_iface</span><span class="p">,</span> <span class="n">riv_iflowface</span><span class="p">])</span>
                    <span class="k">break</span>  <span class="c1"># Exit the loop once the intersecting cell is found</span>

<span class="c1"># Print the river data for verification</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rd</span><span class="p">)</span>

<span class="c1"># Extract coordinates and elevations from rd for plotting</span>
<span class="n">x_cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">rd</span><span class="p">]</span>
<span class="n">y_cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">rd</span><span class="p">]</span>
<span class="n">elevations</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">rd</span><span class="p">]</span>

<span class="c1"># Plot the model grid</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">xorigin</span><span class="p">,</span> <span class="n">xorigin</span> <span class="o">+</span> <span class="n">ncol</span> <span class="o">*</span> <span class="n">cell_size_x</span><span class="p">,</span> <span class="n">yorigin</span><span class="p">,</span> <span class="n">yorigin</span> <span class="o">+</span> <span class="n">nrow</span> <span class="o">*</span> <span class="n">cell_size_y</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Active Cells&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Model Grid with River Cells&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X Coordinate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y Coordinate&#39;</span><span class="p">)</span>

<span class="c1"># Overlay the river cells on the model grid</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_cell</span><span class="p">,</span> <span class="n">y_cell</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">elevations</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Elevation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-nodes">
<h2>Create Nodes<a class="headerlink" href="#create-nodes" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get well and river cell numbers</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Well location (k, i, j) where k is the layer, i is the row, and j is the column</span>
<span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;well&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="n">wel_data</span><span class="p">:</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">well</span>
    <span class="c1"># Calculate the cell number for the well</span>
    <span class="c1"># Cell number is calculated as: ncol * (nrow * k + i) + j</span>
    <span class="n">cell_number</span> <span class="o">=</span> <span class="n">ncol</span> <span class="o">*</span> <span class="p">(</span><span class="n">nrow</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span>
    <span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;well&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_number</span><span class="p">)</span>

<span class="c1"># Print the calculated cell numbers for verification</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Well cell numbers:&quot;</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;well&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-model-simulation">
<h2>Run Model Simulation<a class="headerlink" href="#run-model-simulation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add the output control (OC) package</span>
<span class="c1"># Create the output control (`OC`) Package</span>
<span class="n">headfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.hds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
<span class="n">head_filerecord</span> <span class="o">=</span> <span class="p">[</span><span class="n">headfile</span><span class="p">]</span>
<span class="n">budgetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.cbb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
<span class="n">budget_filerecord</span> <span class="o">=</span> <span class="p">[</span><span class="n">budgetfile</span><span class="p">]</span>
<span class="n">saverecord</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="s2">&quot;ALL&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;BUDGET&quot;</span><span class="p">,</span> <span class="s2">&quot;ALL&quot;</span><span class="p">)]</span>
<span class="n">printrecord</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="s2">&quot;LAST&quot;</span><span class="p">)]</span>
<span class="n">oc</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">mf6</span><span class="o">.</span><span class="n">ModflowGwfoc</span><span class="p">(</span>
    <span class="n">gwf</span><span class="p">,</span>
    <span class="n">saverecord</span><span class="o">=</span><span class="n">saverecord</span><span class="p">,</span>
    <span class="n">head_filerecord</span><span class="o">=</span><span class="n">head_filerecord</span><span class="p">,</span>
    <span class="n">budget_filerecord</span><span class="o">=</span><span class="n">budget_filerecord</span><span class="p">,</span>
    <span class="n">printrecord</span><span class="o">=</span><span class="n">printrecord</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Write the MODFLOW 6 simulation files</span>
<span class="n">sim</span><span class="o">.</span><span class="n">write_simulation</span><span class="p">()</span>

<span class="c1"># Run the MODFLOW 6 simulation</span>
<span class="n">success</span><span class="p">,</span> <span class="n">buff</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">run_simulation</span><span class="p">()</span>
<span class="k">if</span> <span class="n">success</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MODFLOW 6 simulation completed successfully!&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MODFLOW 6 simulation failed. Check the output for errors.&quot;</span><span class="p">)</span>

<span class="c1">#print(gwf.dis.top.array[1, 1])  # Example for cell (1,1,1)</span>
<span class="c1">#print(gwf.dis.botm.array[:, 1, 1])  # Example for the same column</span>

<span class="c1"># Debugging statement for the budget file</span>
<span class="n">budget_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.cbb&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">budget_file</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">budget_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Budget file &#39;</span><span class="si">{</span><span class="n">budget_file</span><span class="si">}</span><span class="s2">&#39; exists and is not empty.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Budget file &#39;</span><span class="si">{</span><span class="n">budget_file</span><span class="si">}</span><span class="s2">&#39; exists but is empty.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Budget file &#39;</span><span class="si">{</span><span class="n">budget_file</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the head file</span>
<span class="n">headfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workspace</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.hds&quot;</span>
<span class="n">hds</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">HeadFile</span><span class="p">(</span><span class="n">headfile</span><span class="p">)</span>
<span class="n">head</span> <span class="o">=</span> <span class="n">hds</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

<span class="c1"># Load the discretization file to access model grid information</span>
<span class="n">dis</span> <span class="o">=</span> <span class="n">gwf</span><span class="o">.</span><span class="n">get_package</span><span class="p">(</span><span class="s2">&quot;DIS&quot;</span><span class="p">)</span>
<span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="n">nlay</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dis</span><span class="o">.</span><span class="n">nrow</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dis</span><span class="o">.</span><span class="n">ncol</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># Load the idomain array to identify active cells</span>
<span class="n">idomain</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="n">idomain</span><span class="o">.</span><span class="n">array</span> <span class="c1"># No results will be visible otherwise</span>

<span class="c1"># Choose the layer you want to plot, e.g., the first layer (layer 0)</span>
<span class="n">layer_to_plot</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># You can change this to any other layer (0-based index)</span>

<span class="c1"># Extract the groundwater head for the specified layer (nrow, ncol)</span>
<span class="n">head_layer</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">layer_to_plot</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

<span class="c1"># Mask the inactive cells in the head_layer array</span>
<span class="n">head_layer_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="n">layer_to_plot</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">head_layer</span><span class="p">)</span>

<span class="c1"># Plot the groundwater head for the chosen layer</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">head_layer_masked</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Groundwater Head (m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Groundwater Head at Layer </span><span class="si">{</span><span class="n">layer_to_plot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Column&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the idomain array to identify active cells</span>
<span class="n">idomain</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="n">idomain</span><span class="o">.</span><span class="n">array</span>

<span class="c1"># Load the surface elevation data</span>
<span class="n">surface_elevation</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">array</span>

<span class="c1"># Choose the layers you want to plot, e.g., the first layer (layer 0) and the last layer</span>
<span class="n">layer_to_plot_first</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># First layer (0-based index)</span>
<span class="n">layer_to_plot_last</span> <span class="o">=</span> <span class="n">nlay</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Last layer (0-based index)</span>

<span class="c1"># Extract the groundwater head for the specified layers (nrow, ncol)</span>
<span class="n">head_layer_first</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">layer_to_plot_first</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
<span class="n">head_layer_last</span> <span class="o">=</span> <span class="n">head</span><span class="p">[</span><span class="n">layer_to_plot_last</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

<span class="c1"># Mask the inactive cells in the head_layer arrays</span>
<span class="n">head_layer_first_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="n">layer_to_plot_first</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">head_layer_first</span><span class="p">)</span>
<span class="n">head_layer_last_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="n">layer_to_plot_last</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">head_layer_last</span><span class="p">)</span>

<span class="c1"># Plot the surface elevation for active cells and overlay groundwater head contours</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot for the first layer</span>
<span class="n">top_active_first</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="n">layer_to_plot_first</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surface_elevation</span><span class="p">)</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_active_first</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                    <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Surface Elevation (m)&#39;</span><span class="p">)</span>
<span class="n">contour_first</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">head_layer_first_masked</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">head_layer_first_masked</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">head_layer_first_masked</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">10</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contour_first</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Surface Elevation and Groundwater Head Contours at Layer </span><span class="si">{</span><span class="n">layer_to_plot_first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Column&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">)</span>

<span class="c1"># Plot for the last layer</span>
<span class="n">top_active_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="n">layer_to_plot_last</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surface_elevation</span><span class="p">)</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_active_last</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                    <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Surface Elevation (m)&#39;</span><span class="p">)</span>
<span class="n">contour_last</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">head_layer_last_masked</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">head_layer_last_masked</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">head_layer_last_masked</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">10</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contour_last</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Surface Elevation and Groundwater Head Contours at Layer </span><span class="si">{</span><span class="n">layer_to_plot_last</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Column&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Choose the layers you want to plot</span>
<span class="n">layers_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">39</span><span class="p">]</span>  <span class="c1"># 1st, 20th, and 40th layers (0-based index)</span>

<span class="c1"># Extract the groundwater head for the specified layers (nrow, ncol)</span>
<span class="n">head_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">head</span><span class="p">[</span><span class="n">layer</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers_to_plot</span><span class="p">]</span>

<span class="c1"># Mask the inactive cells in the head_layer arrays</span>
<span class="n">head_layers_masked</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="n">layer</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">head_layers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers_to_plot</span><span class="p">)]</span>

<span class="c1"># Determine the extent of the active cells</span>
<span class="n">active_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">idomain</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">active_rows</span><span class="p">,</span> <span class="n">active_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">active_cells</span><span class="p">)</span>
<span class="n">row_min</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">=</span> <span class="n">active_rows</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">active_rows</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">col_min</span><span class="p">,</span> <span class="n">col_max</span> <span class="o">=</span> <span class="n">active_cols</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">active_cols</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># Define the extent for the plots</span>
<span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_min</span><span class="p">,</span> <span class="n">col_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row_min</span><span class="p">,</span> <span class="n">row_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Plot the surface elevation for active cells and overlay groundwater head contours</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers_to_plot</span><span class="p">):</span>
    <span class="c1"># Plot for each layer</span>
    <span class="n">top_active</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">idomain</span><span class="p">[</span><span class="n">layer</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surface_elevation</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">top_active</span><span class="p">[</span><span class="n">row_min</span><span class="p">:</span><span class="n">row_max</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col_min</span><span class="p">:</span><span class="n">col_max</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                       <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Surface Elevation (m)&#39;</span><span class="p">)</span>
    <span class="n">contour</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">head_layers_masked</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">row_min</span><span class="p">:</span><span class="n">row_max</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col_min</span><span class="p">:</span><span class="n">col_max</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">head_layers_masked</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">head_layers_masked</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">10</span><span class="p">),</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Surface Elevation and Groundwater Head Contours at Layer </span><span class="si">{</span><span class="n">layer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Column&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the budget file</span>
<span class="n">budget_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workspace</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.cbb&quot;</span>  <span class="c1"># Replace with the path to your budget file</span>
<span class="n">cbb</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">CellBudgetFile</span><span class="p">(</span><span class="n">budget_file</span><span class="p">)</span>

<span class="c1"># List available records in the budget file</span>
<span class="n">record_names</span> <span class="o">=</span> <span class="n">cbb</span><span class="o">.</span><span class="n">get_unique_record_names</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available record names in the budget file:&quot;</span><span class="p">,</span> <span class="n">record_names</span><span class="p">)</span>

<span class="c1"># Choose a valid record name from the list</span>
<span class="n">valid_record_name</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;    FLOW-JA-FACE&#39;</span>  <span class="c1"># Replace with the desired record name</span>

<span class="c1"># Extract the data for the chosen budget term</span>
<span class="n">budget_data</span> <span class="o">=</span> <span class="n">cbb</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">valid_record_name</span><span class="p">)</span>

<span class="c1"># Debugging: Print the shape and type of the extracted data</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type of budget_data: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">budget_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Length of budget_data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">budget_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">budget_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of budget_data[0]: </span><span class="si">{</span><span class="n">budget_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid dimensions: nlay=</span><span class="si">{</span><span class="n">nlay</span><span class="si">}</span><span class="s2">, nrow=</span><span class="si">{</span><span class="n">nrow</span><span class="si">}</span><span class="s2">, ncol=</span><span class="si">{</span><span class="n">ncol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">idomain</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="n">idomain</span><span class="o">.</span><span class="n">array</span>

<span class="c1"># Determine the grid dimensions from the idomain array</span>
<span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">idomain</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># Assuming idomain is already loaded</span>

<span class="c1"># Plot the budget data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Assuming you want to plot the budget for the first time step and first layer</span>
<span class="n">time_step</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">layer</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Debugging: Check if the time_step and layer indices are valid</span>
<span class="k">if</span> <span class="n">time_step</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">budget_data</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">layer</span> <span class="o">&lt;</span> <span class="n">budget_data</span><span class="p">[</span><span class="n">time_step</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># Debugging: Print the shape of the data before reshaping</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of budget_data[</span><span class="si">{</span><span class="n">time_step</span><span class="si">}</span><span class="s2">][</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">, :]: </span><span class="si">{</span><span class="n">budget_data</span><span class="p">[</span><span class="n">time_step</span><span class="p">][</span><span class="n">layer</span><span class="p">,</span><span class="w"> </span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Reshape the data to match the model grid dimensions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flow_data</span> <span class="o">=</span> <span class="n">budget_data</span><span class="p">[</span><span class="n">time_step</span><span class="p">][</span><span class="n">layer</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nlay</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reshaping data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected shape: (</span><span class="si">{</span><span class="n">nlay</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">nrow</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ncol</span><span class="si">}</span><span class="s2">), but got </span><span class="si">{</span><span class="n">budget_data</span><span class="p">[</span><span class="n">time_step</span><span class="p">][</span><span class="n">layer</span><span class="p">,</span><span class="w"> </span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Debugging: Print the shape of the reshaped data</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of reshaped flow_data: </span><span class="si">{</span><span class="n">flow_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">flow_data</span><span class="p">[</span><span class="n">layer</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">valid_record_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1"> (m/day)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">valid_record_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1"> for Layer </span><span class="si">{</span><span class="n">layer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Column&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Row&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid layer index: </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid time_step index: </span><span class="si">{</span><span class="n">time_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-up-modpath">
<h2>Set up MODPATH<a class="headerlink" href="#set-up-modpath" title="Link to this heading">#</a></h2>
<p>Must be run after ModFlow 6</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create MODPATH 7 object</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modpath</span><span class="o">.</span><span class="n">Modpath7</span><span class="p">(</span><span class="n">modelname</span><span class="o">=</span><span class="s1">&#39;mp7&#39;</span><span class="p">,</span> <span class="n">flowmodel</span><span class="o">=</span><span class="n">gwf</span><span class="p">,</span> <span class="n">exe_name</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;C:\Users\u4eeevmq\Documents\Python\Flo_Py\flopy\modflowExe\mp7.exe&#39;</span><span class="p">,</span> <span class="n">model_ws</span><span class="o">=</span> <span class="n">workspace</span><span class="p">)</span>

<span class="c1"># Create MODPATH 7 basic package</span>
<span class="n">mpbas</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modpath</span><span class="o">.</span><span class="n">Modpath7Bas</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">porosity</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Create MODPATH 7 simulation file</span>
<span class="n">mpsim</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modpath</span><span class="o">.</span><span class="n">Modpath7Sim</span><span class="p">(</span>
    <span class="n">mp</span><span class="p">,</span> 
    <span class="n">trackingdirection</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>  <span class="c1"># track in forward direction</span>
    <span class="n">weaksinkoption</span><span class="o">=</span><span class="s1">&#39;pass_through&#39;</span><span class="p">,</span> <span class="c1"># particles pass through weak sinks</span>
    <span class="n">weaksourceoption</span><span class="o">=</span><span class="s1">&#39;pass_through&#39;</span><span class="p">,</span> <span class="c1"># particles pass through weak source</span>
    <span class="n">budgetoutputoption</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="c1"># summary of budget</span>
    <span class="n">referencetime</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="c1"># reference time for simulation (default 0.0)</span>
    <span class="n">stoptimeoption</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">,</span> <span class="c1"># simulation extends past the stop time if necessary</span>
    <span class="n">timepointdata</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">],</span> <span class="c1"># list of time points to track particles</span>
    <span class="n">particlegroups</span><span class="o">=</span><span class="p">[]</span>
<span class="p">)</span>

<span class="c1"># Load the idomain array to identify active cells</span>
<span class="n">idomain</span> <span class="o">=</span> <span class="n">gwf</span><span class="o">.</span><span class="n">dis</span><span class="o">.</span><span class="n">idomain</span><span class="o">.</span><span class="n">array</span>

<span class="c1"># Initialize an empty list to store particle data</span>
<span class="n">particle_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Iterate through the idomain array to find active cells</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idomain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># Loop through layers</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idomain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># Loop through rows</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idomain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>  <span class="c1"># Loop through columns</span>
            <span class="k">if</span> <span class="n">idomain</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Check if the cell is active</span>
                <span class="c1"># Add particle starting location at the center of the cell</span>
                <span class="n">particle_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

<span class="c1"># Create ParticleData object</span>
<span class="n">particle_data</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modpath</span><span class="o">.</span><span class="n">ParticleData</span><span class="p">(</span>
    <span class="n">partlocs</span><span class="o">=</span><span class="n">particle_data</span><span class="p">,</span> 
    <span class="n">structured</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
    <span class="n">localx</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
    <span class="n">localy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
    <span class="n">localz</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>

<span class="c1"># Define particle group with the collected particle data</span>
<span class="n">particlegroup</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">modpath</span><span class="o">.</span><span class="n">ParticleGroupNodeTemplate</span><span class="p">(</span>
    <span class="n">particlegroupname</span><span class="o">=</span><span class="s1">&#39;PG1&#39;</span><span class="p">,</span> 
    <span class="n">particledata</span><span class="o">=</span><span class="n">particle_data</span>
<span class="p">)</span>

<span class="c1"># Add the particle group to the MODPATH simulation</span>
<span class="n">mpsim</span><span class="o">.</span><span class="n">particlegroups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particlegroup</span><span class="p">)</span>

<span class="c1"># Write MODPATH 7 input files</span>
<span class="n">mp</span><span class="o">.</span><span class="n">write_input</span><span class="p">()</span>

<span class="c1"># Run MODPATH 7</span>
<span class="n">success</span><span class="p">,</span> <span class="n">buff</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;MODPATH did not terminate normally.&quot;</span><span class="p">)</span>

<span class="c1"># Post-process results (e.g., read pathline file)</span>
<span class="n">pathline_file</span> <span class="o">=</span> <span class="s1">&#39;./modflow6_workspace/mp7.mppth&#39;</span>
<span class="n">pathlines</span> <span class="o">=</span> <span class="n">flopy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">PathlineFile</span><span class="p">(</span><span class="n">pathline_file</span><span class="p">)</span>
<span class="n">pathline_data</span> <span class="o">=</span> <span class="n">pathlines</span><span class="o">.</span><span class="n">get_alldata</span><span class="p">()</span>

<span class="c1"># Visualize pathlines (example using matplotlib)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">pathline_data</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pl</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">pl</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Example data for GWF model (replace with your actual data)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Create a meshgrid for the 3D surface plot</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

<span class="c1"># Create the 3D surface plot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="p">)])</span>

<span class="c1"># Update layout for better visualization</span>
<span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;3D Surface Plot of GWF Model&#39;</span><span class="p">,</span>
    <span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;X Axis&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Y Axis&#39;</span><span class="p">,</span>
        <span class="n">zaxis_title</span><span class="o">=</span><span class="s1">&#39;Z Axis&#39;</span>
    <span class="p">),</span>
    <span class="n">autosize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Show the plot</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-files-to-personal-directory">Set Files to Personal Directory</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-terrain-elevation">Plot Terrain Elevation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-model-simulation">Set up Model Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-model-grid">Setting up Model Grid</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-terrain-elevation-and-model-grid">Plot Terrain Elevation and Model Grid</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stretch-model-grid-to-terrain-elevation">Stretch Model Grid to Terrain Elevation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-boundary-conditions">Define Boundary Conditions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-dis-package">Create DIS Package</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identify-boundary-cells">Identify Boundary Cells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find-ground-water-elevation">Find Ground Water Elevation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assign-constant-head-to-boundary-conditions">Assign Constant Head to Boundary Conditions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-constant-head-boundary-package">Create the Constant Head Boundary Package</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recharge-package">Recharge Package</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-wells">Add Wells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identify-river-cells">Identify River Cells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-nodes">Create Nodes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-model-simulation">Run Model Simulation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-modpath">Set up MODPATH</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Vanessa Quintana
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>